# Ripple (리플) - 파문 퍼즐 게임 디자인

## 개요

물에 돌을 던져 파문을 만들고, 모든 셀의 목표 숫자를 맞추는 로직 퍼즐 게임.

- **프로젝트 범위**: KAME 내 프로토타입 → 검증 후 독립 앱 분리
- **플랫폼**: 모바일 + 웹 (canvas-mobile)
- **BM**: 광고 수익 (2~3 스테이지마다 전면 광고) + 광고 제거 유료 결제 (독립 앱 분리 시)
- **타겟**: 출퇴근/취침 전 캐주얼 퍼즐 유저

---

## 1. 핵심 규칙

### 게임 보드
- N×N 그리드 (난이도에 따라 5×5 ~ 9×9)
- 각 셀에는 **목표 숫자**(0~9)가 표시되거나, **비어있음**(돌 배치 가능)

### 돌(Stone) 배치
- 플레이어가 빈 셀에 돌을 **탭**하여 배치/제거
- 돌은 **파문(Ripple)**을 사방(상하좌우)으로 방출

### 파문 값 규칙
```
거리 0 (돌 자체):    3
거리 1 (인접 4셀):   2
거리 2 (2칸 떨어진): 1
거리 3+:            영향 없음
```

### 중첩 규칙
- 여러 돌의 파문이 한 셀에서 겹치면 **값이 합산**
- 예: 돌A에서 거리1(=2) + 돌B에서 거리2(=1) = **3**

### 클리어 조건
- 모든 숫자 셀의 값이 목표와 **정확히 일치**하면 클리어
- 돌이 놓인 셀도 숫자를 가질 수 있음 (자기 파문값 3 + 다른 돌의 파문)

### 예시 (5×5, 돌 2개)
```
돌 위치: (1,1)과 (3,3)

돌(1,1) 파문:           돌(3,3) 파문:           합산 결과:
 2  2  1  .  .          .  .  .  .  .           2  2  1  .  .
 2 [3] 2  1  .          .  .  1  2  1           2  3  3  3  1
 1  2  1  .  .          .  1  2 [3] 2           1  3  3  3  2
 .  1  .  .  .          .  .  1  2  1           .  1  1  2  1
 .  .  .  .  .          .  .  .  1  .           .  .  .  1  .
```

합산 결과에서 일부 숫자만 공개하고 나머지를 가리면 → 퍼즐이 됨.

---

## 2. 난이도 & 스테이지 시스템

### 난이도 설정

| 난이도 | 그리드 | 돌 개수 | 힌트 셀 비율 | 예상 시간 | 스테이지 |
|--------|--------|---------|-------------|----------|----------|
| Easy | 5×5 | 2~3개 | 60~70% 공개 | 30초~1분 | 1~20 |
| Normal | 6×6 | 3~4개 | 45~55% 공개 | 1~2분 | 21~50 |
| Hard | 7×7 | 4~6개 | 30~40% 공개 | 2~3분 | 51~100 |
| Expert | 8×8~9×9 | 5~8개 | 20~30% 공개 | 3~5분 | 101+ |

### 스테이지 진행 방식
- 게임 시작 시 **스테이지 1**부터 순차 진행
- 각 스테이지마다 **난이도 범위 내에서 랜덤 퍼즐 생성**
- 스테이지 번호가 올라갈수록 난이도 구간이 자연스럽게 상승
- 같은 난이도 안에서도 돌 개수/힌트 비율이 **랜덤으로 변동**

### 광고 시스템 (독립 앱 분리 시)
- 2~3 스테이지 클리어마다 전면 광고(Interstitial) 1회
- 광고 타이밍: 스테이지 클리어 축하 화면 → 광고 → 다음 스테이지
- 광고 제거 유료 결제 옵션

### 점수 시스템
```
스테이지 점수 = 난이도 배율 × max(0, 기본시간 - 소요시간)

난이도 배율: Easy=×1, Normal=×2, Hard=×3, Expert=×5
기본시간:    Easy=60초, Normal=120초, Hard=180초, Expert=300초
```
- 힌트 사용 시 30초 패널티
- 누적 점수로 총점 랭킹

---

## 3. UI/UX 디자인

### 화면 구성 (모바일, 세로 모드)
```
┌─────────────────────────┐
│  Stage 12    ★ 2,450    │  상단 HUD: 스테이지 번호, 누적 점수
│  Normal  ⏱ 01:23  💡2  │  난이도, 타이머, 남은 힌트 수
├─────────────────────────┤
│                         │
│    2  .  1  .  3        │
│    .  .  .  2  .        │
│    1  .  .  .  1        │  메인 그리드
│    .  2  .  .  .        │
│    3  .  1  .  2        │
│                         │
├─────────────────────────┤
│  돌: 3개 배치 / 3개 필요  │  하단 정보: 돌 배치 현황
│                         │
│   [힌트]  [검증]  [리셋] │  하단 버튼
└─────────────────────────┘
```

### 셀 상태별 표현

| 상태 | 시각적 표현 |
|------|------------|
| 숫자 셀 (목표) | 숫자가 보이는 셀, 배경색 연한 톤 |
| 빈 셀 (배치 가능) | 점( · ) 표시, 탭하면 돌 배치 |
| 돌이 놓인 셀 | 돌 아이콘 + 파문 애니메이션 |
| 파문 범위 표시 | 돌 주변에 물결 이펙트 (반투명 원) |
| 오류 셀 | 빨간 하이라이트 + 흔들림 |
| 정답 확인된 셀 | 초록 체크 + 부드러운 글로우 |

### 핵심 인터랙션
1. **탭**: 빈 셀 탭 → 돌 배치 (다시 탭 → 돌 제거)
2. **파문 미리보기**: 돌 배치 시 파문 범위가 실시간으로 표시
3. **검증 버튼**: 현재 배치가 맞는지 확인 (틀린 셀 하이라이트)
4. **힌트 버튼**: 정답 돌 위치 하나를 공개 (30초 패널티)
5. **리셋 버튼**: 모든 돌 제거

### 클리어 연출
1. 모든 숫자 일치 → 파문이 동시에 확산되는 물결 애니메이션
2. 셀이 순차적으로 빛남 + 축하 이펙트
3. 점수 카운트업 애니메이션
4. "Next Stage" 버튼

### 테마 (물/파문)
- 배경: 연한 수색(水色) 계열
- 돌: 깔끔한 원형, 드롭 시 물방울 이펙트
- 파문: 동심원으로 퍼지는 물결 애니메이션
- 셀: 부드러운 파스텔 톤

---

## 4. 퍼즐 생성 알고리즘

### 생성 흐름
```
1. 랜덤 돌 배치 생성 → N×N 그리드에 K개 돌 랜덤 배치
2. 파문 값 계산 → 모든 셀의 파문 합산 값 계산
3. 퍼즐 변환 → 일부 셀 값을 "목표 숫자"로 공개, 나머지는 빈 셀
4. 유일해 검증 → 공개된 숫자만으로 정답이 유일한지 검증
5. 난이도 검증 → 힌트 셀 비율이 목표 범위 내인지 확인
```

### 유일해 보장: 백트래킹 솔버
1. 정답 배치에서 시작
2. 숫자 셀을 하나씩 제거(가리기)하면서 솔버 실행
3. 솔버가 2개 이상의 해 → 해당 숫자를 다시 공개
4. 솔버가 1개의 해만 → 계속 제거
5. 목표 힌트 비율 도달까지 반복

### 성능 최적화
- 배치 기반 비동기 처리 (setTimeout 배칭)
- 5×5는 즉시, 9×9도 1~2초 내 생성 목표
- 실패 시 적응적 재시도

### 난이도별 파라미터
```typescript
const DIFFICULTY_CONFIG = {
  easy:   { size: 5, stones: [2,3], hintRatio: [0.6, 0.7], maxAttempts: 200 },
  normal: { size: 6, stones: [3,4], hintRatio: [0.45, 0.55], maxAttempts: 500 },
  hard:   { size: 7, stones: [4,6], hintRatio: [0.3, 0.4], maxAttempts: 1000 },
  expert: { size: [8,9], stones: [5,8], hintRatio: [0.2, 0.3], maxAttempts: 2000 },
};
```

---

## 5. 아키텍처 (KAME 프로토타입)

### 디렉토리 구조
```
app/(canvas-mobile)/ripple/
├── _lib/
│   ├── config.ts       # GAME_META + 난이도 설정 + 색상 팔레트
│   ├── types.ts        # TCell, TBoard, TPuzzle, TParticle 등
│   ├── generator.ts    # 퍼즐 생성 + 유일해 검증
│   └── game.ts         # 게임 루프, 렌더링, 입력 처리
├── _components/
│   └── ripple.tsx      # Canvas 컴포넌트 (CSS transform 스케일링)
├── layout.tsx
└── page.tsx
```

### GAME_META
```typescript
export const GAME_META: TGameMeta = {
  id: 'ripple',
  title: '리플',
  engine: 'canvas',
  platform: 'both',
  touchControls: 'tap',
  orientation: 'portrait',
  category: 'puzzle',
  difficulty: 'progressive',
};
```

### 프로토타입 범위 (MVP)

**포함:**
- 핵심 게임 로직 (돌 배치, 파문 계산, 클리어 검증)
- 퍼즐 생성 (유일해 보장)
- 4단계 난이도 (Easy~Expert)
- 스테이지 진행 시스템
- 파문 애니메이션
- 터치 + 키보드 조작
- HUD (타이머, 점수, 힌트)
- 힌트 시스템
- 클리어 축하 연출
- 점수 저장/랭킹 (KAME 인프라)

**제외 (독립 앱 분리 시):**
- 광고 시스템 (AdMob)
- 유료 결제 (광고 제거)
- 로컬 진행 저장
- 일일 챌린지 모드
- 사전 생성 퍼즐 풀
- 튜토리얼

### 에러 처리
- 퍼즐 생성 실패: 최대 재시도 후 난이도 한 단계 내려서 재시도
- 타이머 0도달: 게임오버가 아닌 점수 0점 클리어 (계속 풀 수 있음)
- 브라우저 탭 전환: 자동 일시정지
